<div class="entry">

  <div class="entrytitle">
    <h2>Select a File to upload...</h2>
  </div>

  <a href="#" id="upload_button">Upload</a>

  <div class="upload">
   <% form_for :asset, :html => { :id => "upload", :multipart => true } do |f| %>

     <div id="upload_progress_bar" style="display:none">
       <div id="progressbar">&nbsp;</div>
       <div id="percents"></div>
     </div>

     <%= f.text_area :comment, :rows => 15, :cols => 5 %><br>

     <%= f.submit %>
   <% end %>
  </div>

  <div class="entrybody">
    <p>Take care files may be deleted later!!</p>

    <div id="assets" style="min-height: 500px;">
        <%= render @assets %>
    </div>
  </div>

</div>

<hr class="space" />


  <script type="text/javascript" charset="utf-8">
    $(document).ready(function() {
      var interval;

      var upload = new AjaxUpload( $('#upload_button'), {
        action: '/assets?X-Progress-ID=<%= @file_id  %>',
        onSubmit : function(file, ext){
            var v = $('input[name=authenticity_token]').val();
            
            this.setData({
            'authenticity_token': v,
            'X-Progress-ID': <%= @file_id  %>
          });
          
          $('#upload_button').hide();
          $('#upload_progress_bar').show();
          this.disable();
        
          // Uploding -> Uploading. -> Uploading...
          interval = window.setInterval(function(){            
            jQuery.ajax({
                type: "GET",
                url: "/progress?X-Progress-ID=<%= @file_id  %>",
                dataType: "json",
                success: function(upload) {
                  if (upload.state == 'uploading') {                             
                     upload.percents = Math.floor((upload.received / upload.size)*1000)/10;
                     $('#percents').html(upload.percents);
                    // 
                    // var bar = $.browser.safari ? $(options.progressBar, parent.document) : $(options.progressBar);
                    // bar.css({width: upload.percents+'%'});
                    // options.uploading(upload);
                  }
            
                  if (upload.state == 'done' || upload.state == 'error') {
                    window.clearInterval(interval);
                    $('#upload_button').show();
                    $('#upload_progress_bar').hide();
                    this.enable();
                  }
                  if (upload.state == 'error') {
                    alert("Error");
                  }
                }
            });
          }, 1000);
          
        },
        onComplete: function(file, response){
          alert(file);
          window.clearInterval(interval);
          this.enable();
        }
      });
      
    });
  </script>